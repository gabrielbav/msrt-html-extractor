# Database Schema Configuration
# Defines tables, columns, and import order for the MicroStrategy extractor

# Entity tables (must be created before relationship tables)
entities:
  - name: reports
    csv_file: Reports.csv
    description: Report/Document entities
    columns:
      - name: id
        type: VARCHAR(32)
        primary_key: true
        description: Unique report ID
      - name: name
        type: TEXT
        nullable: false
        description: Report name
      - name: file_path
        type: TEXT
        nullable: false
        description: Path to HTML file

  - name: datasets
    csv_file: DataSets.csv
    description: Dataset entities (Intelligent Cubes or Reports)
    columns:
      - name: id
        type: VARCHAR(32)
        primary_key: true
      - name: name
        type: TEXT
        nullable: false
      - name: file_path
        type: TEXT
      - name: application_object
        type: VARCHAR(50)
        description: "Type: CuboInteligente, Report, or Shortcut"
      - name: graphic
        type: VARCHAR(100)
        description: "Graphic type for Report datasets"

  - name: attributes
    csv_file: Attributes.csv
    description: Attribute entities
    columns:
      - name: id
        type: VARCHAR(32)
        primary_key: true
      - name: name
        type: TEXT
        nullable: false
        description: Official name from Atributo.html
      - name: name_on_dataset
        type: TEXT
        description: Name as it appears in the dataset
      - name: file_path
        type: TEXT
      - name: application_schema
        type: VARCHAR(50)

  - name: functions
    csv_file: Functions.csv
    description: Aggregation function entities
    columns:
      - name: name
        type: VARCHAR(50)
        primary_key: true
        description: "Function name (e.g., Sum, Avg, Max)"
      - name: file_path
        type: TEXT

  - name: metrics
    csv_file: Metrics.csv
    description: Metric entities (simple and composite)
    columns:
      - name: id
        type: VARCHAR(32)
        primary_key: true
      - name: name
        type: TEXT
        nullable: false
      - name: file_path
        type: TEXT
      - name: application_object
        type: VARCHAR(50)
      - name: tipo
        type: VARCHAR(20)
        nullable: false
        description: "'simples' or 'composto'"
      - name: formula
        type: TEXT

  - name: facts
    csv_file: Facts.csv
    description: Fact entities
    columns:
      - name: id
        type: VARCHAR(32)
        primary_key: true
      - name: name
        type: TEXT
        nullable: false
      - name: file_path
        type: TEXT

  - name: tables
    csv_file: Tables.csv
    description: Logical table entities
    columns:
      - name: id
        type: VARCHAR(32)
        primary_key: true
      - name: name
        type: TEXT
        nullable: false
      - name: file_path
        type: TEXT

# Relationship tables (created after entities)
relationships:
  - name: report_dataset
    csv_file: Report_DataSet.csv
    description: Report to Dataset relationship
    columns:
      - name: report_id
        type: VARCHAR(32)
        foreign_key:
          table: reports
          column: id
      - name: dataset_id
        type: VARCHAR(32)
        foreign_key:
          table: datasets
          column: id
    primary_key: [report_id, dataset_id]

  - name: dataset_attribute
    csv_file: DataSet_Attribute.csv
    description: Dataset to Attribute relationship
    columns:
      - name: dataset_id
        type: VARCHAR(32)
        foreign_key:
          table: datasets
          column: id
      - name: attribute_id
        type: VARCHAR(32)
        foreign_key:
          table: attributes
          column: id
    primary_key: [dataset_id, attribute_id]

  - name: dataset_metric
    csv_file: DataSet_Metric.csv
    description: Dataset to Metric relationship
    columns:
      - name: dataset_id
        type: VARCHAR(32)
        foreign_key:
          table: datasets
          column: id
      - name: metric_id
        type: VARCHAR(32)
        foreign_key:
          table: metrics
          column: id
    primary_key: [dataset_id, metric_id]

  - name: attribute_form_table
    csv_file: AttributeForm_Table.csv
    description: Attribute Form to Logical Table relationship
    columns:
      - name: attribute_id
        type: VARCHAR(32)
        foreign_key:
          table: attributes
          column: id
      - name: form_name
        type: TEXT
        nullable: false
      - name: table_id
        type: VARCHAR(32)
        foreign_key:
          table: tables
          column: id
      - name: column_name
        type: TEXT
        description: SQL column name from EXPRESSÃO field
    primary_key: [attribute_id, form_name, table_id]

  - name: metric_function
    csv_file: Metric_Function.csv
    description: Metric to Function relationship
    columns:
      - name: metric_id
        type: VARCHAR(32)
        foreign_key:
          table: metrics
          column: id
      - name: function_name
        type: VARCHAR(50)
        foreign_key:
          table: functions
          column: name
    primary_key: [metric_id, function_name]

  - name: metric_fact
    csv_file: Metric_Fact.csv
    description: Metric to Fact relationship
    columns:
      - name: metric_id
        type: VARCHAR(32)
        foreign_key:
          table: metrics
          column: id
      - name: fact_id
        type: VARCHAR(32)
        foreign_key:
          table: facts
          column: id
    primary_key: [metric_id, fact_id]

  - name: fact_table
    csv_file: Fact_Table.csv
    description: Fact to Logical Table relationship
    columns:
      - name: fact_id
        type: VARCHAR(32)
        foreign_key:
          table: facts
          column: id
      - name: table_id
        type: VARCHAR(32)
        foreign_key:
          table: tables
          column: id
      - name: column_name
        type: TEXT
        description: SQL column name from EXPRESSÃO field
    primary_key: [fact_id, table_id]

  - name: metric_metric
    csv_file: Metric_Metric.csv
    description: Composite Metric to Component Metric relationship
    columns:
      - name: parent_metric_id
        type: VARCHAR(32)
        foreign_key:
          table: metrics
          column: id
      - name: child_metric_id
        type: VARCHAR(32)
        foreign_key:
          table: metrics
          column: id
    primary_key: [parent_metric_id, child_metric_id]

# Import order (respects foreign key constraints)
import_order:
  # Entities first
  - reports
  - datasets
  - attributes
  - functions
  - metrics
  - facts
  - tables
  # Relationships second
  - report_dataset
  - dataset_attribute
  - dataset_metric
  - attribute_form_table
  - metric_function
  - metric_fact
  - fact_table
  - metric_metric

